name: ğŸ—ï¸ Users API CI Pipeline

env:
  DOTNET_VERSION: '9.0.x'

on:
  pull_request:
    branches: [main]
    paths:
      - 'test/**'
      - 'services/users/**'
      - 'shared/common/**'
      - 'src/**'
      - 'test/**'
      - '.github/workflows/**'
      - 'services/users/.github/workflows/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for ACR'
        default: 'dev-rodrigo'
        type: choice
        options:
          - dev
          - prod
      skip-tests:
        description: 'Skip unit tests (emergency only)'
        default: false
        type: boolean
      skip-security-scan:
        description: 'Skip Trivy security scan (emergency only)'
        default: false
        type: boolean

env:
  SERVICE_NAME: users-api
  SOLUTION_FILE: TC.CloudGames.Users.sln
  DOCKERFILE_PATH: services/users/src/Adapters/Inbound/TC.CloudGames.Users.Api/Dockerfile
  WORKSPACE_PATH: tc-cloudgames-solution/services/users
  DOTNET_VERSION: '9.0.x'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 1: Validate trigger conditions
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: ğŸ” Validate Trigger
    runs-on: ubuntu-latest
    outputs:
      should-continue: ${{ steps.check.outputs.should-continue }}
      environment: ${{ steps.check.outputs.environment }}
    steps:
      - name: âœ… Check trigger conditions
        id: check
        run: |
          echo "should-continue=true" >> $GITHUB_OUTPUT
          echo "environment=${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_OUTPUT
          echo "ğŸš€ Pipeline triggered by: ${{ github.event_name }}"
          echo "ğŸ“Œ Branch: ${{ github.ref_name }}"
          echo "ğŸ”– Commit: ${{ github.sha }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 2: Run unit tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write
    steps:
      - name: ğŸ“‚ Prepare workspace
        run: mkdir -p ${{ env.WORKSPACE_PATH }}

      - name: ğŸ“¥ Checkout API repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKSPACE_PATH }}

      - name: ğŸ“¥ Checkout shared repository
        uses: actions/checkout@v4
        with:
          repository: rdpresser/tc-cloudgames-common
          path: tc-cloudgames-solution/shared/common
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore ${{ env.WORKSPACE_PATH }}/${{ env.SOLUTION_FILE }}

      - name: ğŸ—ï¸ Build solution
        run: dotnet build ${{ env.WORKSPACE_PATH }}/${{ env.SOLUTION_FILE }} --no-restore --configuration Release

      - name: ğŸ§ª Run unit tests with coverage
        run: |
          dotnet test ${{ env.WORKSPACE_PATH }}/${{ env.SOLUTION_FILE }} \
            --no-build \
            --configuration Release \
            --logger "trx;LogFileName=unit-tests.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ${{ env.WORKSPACE_PATH }}/test-results \
            --verbosity normal

      - name: ğŸ“Š Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ğŸ§ª Unit Tests Results
          path: ./test-results/*.trx
          reporter: dotnet-trx
          fail-on-error: true
          working-directory: ${{ env.WORKSPACE_PATH }}

      - name: ğŸ“Š Generate coverage report
        if: always()
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          reportgenerator \
            "-reports:${{ env.WORKSPACE_PATH }}/test-results/**/coverage.cobertura.xml" \
            "-targetdir:${{ env.WORKSPACE_PATH }}/coverage-report" \
            "-reporttypes:Html;Badges;TextSummary" \
            "-verbosity:Info"

      - name: ğŸ“ˆ Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: |
            ${{ env.WORKSPACE_PATH }}/coverage-report/
            ${{ env.WORKSPACE_PATH }}/test-results/*.trx
            ${{ env.WORKSPACE_PATH }}/test-results/**/coverage.cobertura.xml
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 3: Skip tests placeholder (when skip-tests is true)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-skipped:
    name: ğŸš« Tests Skipped
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-continue == 'true' && github.event.inputs.skip-tests == 'true'
    steps:
      - name: âš ï¸ Unit tests skipped
        run: |
          echo "::warning::Unit tests were skipped via workflow input"
          echo "âœ… Proceeding without running tests"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Job 4: Build, Scan, and Push Docker image
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-push:
    name: ğŸ³ Build & Push
    runs-on: ubuntu-latest
    needs: [validate, test, test-skipped]
    if: |
      always() &&
      needs.validate.outputs.should-continue == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped' || needs.test-skipped.result == 'success')
    environment: ${{ needs.validate.outputs.environment }}
    permissions:
      contents: read
      security-events: write
    outputs:
      image-tag: ${{ steps.build-vars.outputs.image-tag }}
      image-uri: ${{ steps.build-vars.outputs.image-uri }}
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“‚ Prepare workspace
        run: mkdir -p ${{ env.WORKSPACE_PATH }}

      - name: ğŸ“¥ Checkout API repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.WORKSPACE_PATH }}

      - name: ğŸ“¥ Checkout shared repository
        uses: actions/checkout@v4
        with:
          repository: rdpresser/tc-cloudgames-common
          path: tc-cloudgames-solution/shared/common
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Azure Authentication
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Azure Login
        if: github.event_name != 'pull_request'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”— Get ACR Info
        if: github.event_name != 'pull_request'
        id: acr-info
        run: |
          ENV_PREFIX="${{ needs.validate.outputs.environment }}"
          RESOURCE_GROUP="tc-cloudgames-solution-${ENV_PREFIX}-rg"
          ACR_NAME=$(az acr list --resource-group $RESOURCE_GROUP --query "[?starts_with(name, 'tccloudgames${ENV_PREFIX}')].name" -o tsv | head -1)
          ACR_LOGIN_SERVER="${ACR_NAME}.azurecr.io"

          echo "acr-name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "acr-login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ACR: $ACR_LOGIN_SERVER"

      - name: ğŸ—ï¸ Prepare Build Variables
        id: build-vars
        run: |
          IMAGE_TAG="$(date +%Y%m%d-%H%M%S)-$(echo ${{ github.sha }} | cut -c1-8)"
          IMAGE_URI="${{ steps.acr-info.outputs.acr-login-server }}/${{ env.SERVICE_NAME }}:${IMAGE_TAG}"
          IMAGE_URI_LATEST="${{ steps.acr-info.outputs.acr-login-server }}/${{ env.SERVICE_NAME }}:latest"

          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "image-uri-latest=$IMAGE_URI_LATEST" >> $GITHUB_OUTPUT

          echo "ğŸ”– Image Tag: $IMAGE_TAG"
          echo "ğŸ“¦ Image URI: $IMAGE_URI"

      - name: ğŸ³ Login to Azure Container Registry
        if: github.event_name != 'pull_request'
        run: az acr login --name ${{ steps.acr-info.outputs.acr-name }}

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Build Docker Image (without push)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸ Build Docker Image
        uses: docker/build-push-action@v5
        id: docker-build
        with:
          context: ./tc-cloudgames-solution
          file: ./tc-cloudgames-solution/${{ env.DOCKERFILE_PATH }}
          push: false
          load: true
          tags: |
            ${{ steps.build-vars.outputs.image-uri }}
            ${{ steps.build-vars.outputs.image-uri-latest }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: âœ… Build completed
        run: |
          echo "ğŸ—ï¸ Docker image built successfully"
          echo "ğŸ“¦ Image: ${{ steps.build-vars.outputs.image-uri }}"
          docker images | grep ${{ env.SERVICE_NAME }} || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Security Scan with Trivy
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”’ Security Scan with Trivy
        if: github.event.inputs.skip-security-scan != 'true'
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ steps.build-vars.outputs.image-uri }}
          format: table
          vuln-type: os,library
          severity: HIGH,CRITICAL
          exit-code: 1
          ignore-unfixed: true
          timeout: 5m

      - name: ğŸ“Š Generate Trivy SARIF Report
        if: always() && github.event.inputs.skip-security-scan != 'true'
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ steps.build-vars.outputs.image-uri }}
          format: sarif
          output: trivy-results.sarif
          vuln-type: os,library
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          timeout: 5m

      - name: ğŸ“¤ Upload Trivy Results to GitHub Security
        if: always() && github.event.inputs.skip-security-scan != 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

      - name: âœ… Security scan passed
        if: github.event.inputs.skip-security-scan != 'true'
        run: echo "ğŸ”’ No HIGH/CRITICAL vulnerabilities found"

      - name: âš ï¸ Security scan skipped
        if: github.event.inputs.skip-security-scan == 'true'
        run: echo "::warning::Security scan was skipped via workflow input"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Push to ACR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Push Docker Image to ACR
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./tc-cloudgames-solution
          file: ./tc-cloudgames-solution/${{ env.DOCKERFILE_PATH }}
          push: true
          tags: |
            ${{ steps.build-vars.outputs.image-uri }}
            ${{ steps.build-vars.outputs.image-uri-latest }}
          cache-from: type=gha
          platforms: linux/amd64

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Verify Push
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… Verify Image in ACR
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ” Verifying image in ACR..."
          az acr repository show-tags \
            --name ${{ steps.acr-info.outputs.acr-name }} \
            --repository ${{ env.SERVICE_NAME }} \
            --orderby time_desc \
            --top 5 \
            --output table

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… BUILD COMPLETED SUCCESSFULLY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Image Tag:    ${{ steps.build-vars.outputs.image-tag }}"
          echo "ğŸ“¦ Image URI:    ${{ steps.build-vars.outputs.image-uri }}"
          echo "ğŸ“¦ Latest Tag:   ${{ steps.build-vars.outputs.image-uri-latest }}"
          echo "ğŸ”’ Security:     Trivy scan passed"
          echo "ğŸš€ Next Step:    ArgoCD will sync the new image to AKS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"